<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KR ETF Dividend Insight</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #000000;
            color: #e5e5e5;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }

        .glass {
            background: rgba(30, 30, 30, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .text-up {
            color: #fe4242;
        }

        /* Red for up in Korea */
        .text-down {
            color: #3b82f6;
        }

        /* Blue for down in Korea */
        .text-yield {
            color: #4ade80;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 3px;
        }

        .badge-new {
            background-color: #3b82f6;
            color: white;
            padding: 2px 4px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: bold;
        }

        .transition-width {
            transition: width 0.3s ease-in-out;
        }
    </style>
</head>

<body class="h-screen flex flex-col">

    <!-- TOP KPI BAR -->
    <header class="h-16 border-b border-gray-800 bg-black flex items-center px-4 justify-between shrink-0 z-20">
        <div class="flex items-center">
            <h1 class="text-xl font-bold bg-gradient-to-r from-blue-400 to-indigo-500 bg-clip-text text-transparent">KR
                ETF Dividend Insight</h1>
            <span class="text-xs font-bold text-gray-400 ml-2 self-end mb-1">v1.0.1</span>
            <button onclick="openAbout()" class="ml-2 p-1 text-gray-400 hover:text-blue-400 transition" title="About">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </button>
        </div>
        <div class="flex space-x-6 text-sm items-center">
            <!-- Update Button -->
            <button id="btn-update-data" onclick="triggerUpdate()"
                class="bg-gray-800 hover:bg-gray-700 text-gray-300 text-xs px-3 py-1.5 rounded transition flex items-center gap-2 border border-gray-700">
                <span>ğŸ”„</span> Update Data
            </button>
            <button onclick="openSimulator()"
                class="bg-gray-800 hover:bg-gray-700 text-green-400 text-xs px-3 py-1.5 rounded transition flex items-center gap-2 border border-gray-700">
                <span>ğŸ“ˆ</span> Simulator
            </button>
            <button onclick="openAnalysis()"
                class="bg-gray-800 hover:bg-gray-700 text-blue-400 text-xs px-3 py-1.5 rounded transition flex items-center gap-2 border border-gray-700">
                <span>ğŸ°</span> Analysis
            </button>
            <button onclick="openCalendar()"
                class="bg-gray-800 hover:bg-gray-700 text-purple-400 text-xs px-3 py-1.5 rounded transition flex items-center gap-2 border border-gray-700">
                <span>ğŸ“…</span> Calendar
            </button>
            <div class="h-8 w-px bg-gray-800 mx-2"></div>
            <div>
                <span class="text-gray-500 text-xs block">ì´ í‰ê°€ê¸ˆì•¡</span>
                <span id="kpi-total-val" class="font-bold text-lg">â‚©0</span>
            </div>
            <div>
                <span class="text-gray-500 text-xs block">ì›” í˜„ê¸ˆíë¦„ (ì˜ˆìƒ)</span>
                <span id="kpi-monthly" class="font-bold text-lg text-yield">â‚©0</span>
            </div>
            <div>
                <span class="text-gray-500 text-xs block">ì—° í˜„ê¸ˆíë¦„ (ì˜ˆìƒ)</span>
                <span id="kpi-annual" class="font-bold text-lg text-gray-300">â‚©0</span>
            </div>
            <div>
                <span class="text-gray-500 text-xs block">í¬íŠ¸í´ë¦¬ì˜¤ ì´ìˆ˜ìµë¥ (1Y)</span>
                <span id="kpi-return" class="font-bold text-lg">0.00%</span>
            </div>
        </div>
    </header>

    <!-- CONTENT CONTAINER -->
    <div class="flex-1 flex overflow-hidden relative">

        <!-- LEFT: UNIVERSE LIST -->
        <div id="panel-left"
            class="relative flex flex-col h-full bg-[#0a0a0a] border-r border-gray-800 shrink-0 min-w-0"
            style="width: 65%;">
            <!-- Search & Filter -->
            <div class="p-3 border-b border-gray-800 space-y-2 shrink-0">
                <div class="flex gap-2">
                    <input type="text" id="search-input" placeholder="í‹°ì»¤ ë˜ëŠ” ì´ë¦„ ê²€ìƒ‰"
                        class="flex-1 bg-[#1a1a1a] border border-gray-700 rounded px-3 py-2 text-sm focus:outline-none focus:border-blue-500 text-white">
                    <!-- Custom Sort Dropdown -->
                    <div class="relative inline-block text-left" id="sort-dropdown-container">
                        <button onclick="toggleSortMenu()" id="sort-btn"
                            class="h-full flex items-center gap-1 bg-[#1a1a1a] border border-gray-700 rounded px-2 text-xs text-gray-300 hover:text-white transition focus:outline-none whitespace-nowrap">
                            <span id="current-sort-label">ì—° ë¶„ë°°ìœ¨ ë†’ì€ ìˆœ</span>
                            <svg class="w-3 h-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>

                        <!-- Dropdown Menu -->
                        <div id="sort-menu"
                            class="hidden absolute right-0 mt-1 w-64 bg-[#1a1a1a] border border-gray-700 rounded-md shadow-xl z-50 overflow-visible">
                            <!-- Options ... -->
                            <div class="group relative flex items-start justify-between px-3 py-3 hover:bg-[#222] cursor-pointer border-b border-gray-800"
                                onclick="setSort('name')">
                                <div><span class="block text-xs text-gray-200 font-bold mb-0.5">ì´ë¦„ìˆœ</span></div>
                            </div>
                            <div class="group relative flex items-start justify-between px-3 py-3 hover:bg-[#222] cursor-pointer border-b border-gray-800"
                                onclick="setSort('yield')">
                                <div><span class="block text-xs text-gray-200 font-bold mb-0.5">ì—°ë¶„ë°°ìœ¨ ë†’ì€ìˆœ</span></div>
                                <div class="relative ml-2 text-gray-500 p-1"><span class="text-[10px]">TTM ìš°ì„ </span>
                                </div>
                            </div>
                            <div class="group relative flex items-start justify-between px-3 py-3 hover:bg-[#222] cursor-pointer border-b border-gray-800"
                                onclick="setSort('total_return_1y')">
                                <div><span class="block text-xs text-gray-200 font-bold mb-0.5">ì´ìˆ˜ìµ 1Y ë†’ì€ìˆœ</span></div>
                            </div>
                            <div class="group relative flex items-start justify-between px-3 py-3 hover:bg-[#222] cursor-pointer"
                                onclick="setSort('return_1y')">
                                <div><span class="block text-xs text-gray-200 font-bold mb-0.5">ê°€ê²©ìƒìŠ¹ 1Y ë†’ì€ìˆœ</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- List Header (Dynamic) -->
            <div id="list-header"
                class="grid px-4 py-2 bg-[#151515] text-[10px] text-gray-500 font-semibold border-b border-gray-800 items-center shrink-0">
                <!-- Injected via JS -->
            </div>

            <!-- List Area -->
            <div id="universe-list"
                class="flex-1 overflow-y-auto overflow-x-hidden space-y-0 min-h-0 relative scroll-smooth">
                <!-- Items injected here -->
            </div>

            <!-- Scroll To Top Button -->
            <button id="btn-scroll-top" onclick="scrollToTop()"
                class="absolute bottom-6 right-6 w-10 h-10 bg-blue-600 hover:bg-blue-500 text-white rounded-full shadow-lg flex items-center justify-center transition-opacity duration-300 opacity-0 pointer-events-none z-50"
                style="right: 24px;">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18">
                    </path>
                </svg>
            </button>
        </div>

        <!-- SPLITTER 1 -->
        <div id="splitter-1"
            class="w-[4px] bg-[#111] hover:bg-blue-600 cursor-col-resize z-50 transition-colors flex flex-col justify-center items-center group shrink-0">
            <div class="w-0.5 h-8 bg-gray-700 group-hover:bg-white rounded"></div>
        </div>

        <!-- CENTER: DETAIL (Hidden by default) -->
        <div id="panel-center"
            class="hidden flex-col h-full bg-[#050505] border-r border-gray-800 overflow-y-auto relative min-w-0"
            style="width: 40%; display: none;">
            <button onclick="closeDetail()"
                class="absolute top-4 right-4 text-gray-500 hover:text-white z-10 p-2">âœ•</button>
            <div id="detail-content" class="p-6 space-y-6">
                <!-- Detail Injected Here -->
            </div>
        </div>

        <!-- SPLITTER 2 -->
        <div id="splitter-2"
            class="hidden w-[4px] bg-[#111] hover:bg-blue-600 cursor-col-resize z-50 transition-colors flex-col justify-center items-center group shrink-0">
            <div class="w-0.5 h-8 bg-gray-700 group-hover:bg-white rounded"></div>
        </div>

        <!-- RIGHT: PORTFOLIO -->
        <div id="panel-right" class="flex flex-col h-full bg-[#0a0a0a] min-w-0 shrink-0" style="flex: 1;">
            <div class="p-3 border-b border-gray-800 shrink-0 flex justify-between items-center">
                <h2 class="font-bold text-gray-300 text-sm">My Holdings</h2>
                <div class="flex bg-[#222] rounded p-0.5">
                    <button onclick="togglePortfolioView('list')" id="btn-pf-list"
                        class="px-2 py-0.5 text-[10px] rounded bg-gray-600 text-white font-bold transition">List</button>
                    <button onclick="togglePortfolioView('trend')" id="btn-pf-trend"
                        class="px-2 py-0.5 text-[10px] rounded text-gray-500 hover:text-white transition">Trend</button>
                </div>
                <!-- Manage Button -->
                <button onclick="openManageModal()" class="ml-2 text-gray-400 hover:text-white text-xs"
                    title="Manage Portfolios">
                    ğŸ“‚
                </button>
            </div>

            <!-- TREND VIEW (Hidden by default, stacks on top) -->
            <div id="view-portfolio-trend"
                class="hidden shrink-0 h-[280px] flex-col border-b border-gray-800 bg-[#0e0e0e]">
                <!-- Stats Header -->
                <div class="flex justify-around items-center py-2 px-4 border-b border-gray-800 text-xs">
                    <div class="text-center">
                        <div class="text-gray-500 text-[10px]">Start Value</div>
                        <div id="trend-start-val" class="font-bold text-gray-300">-</div>
                    </div>
                    <div class="text-center">
                        <div class="text-gray-500 text-[10px]">End Value</div>
                        <div id="trend-end-val" class="font-bold text-white">-</div>
                    </div>
                    <div class="text-center">
                        <div class="text-gray-500 text-[10px]">Return</div>
                        <div id="trend-return" class="font-bold text-gray-300">-</div>
                    </div>
                </div>

                <div class="flex-1 relative p-2">
                    <canvas id="portfolioChart"></canvas>
                </div>
                <div class="text-center text-[10px] text-gray-600 pb-1">
                    * 1Y Backtest (Qty Held Constant)
                </div>
            </div>

            <!-- LIST VIEW (Always flex-1, takes remaining space) -->
            <div id="view-portfolio-list" class="flex-1 flex flex-col overflow-hidden min-h-0">
                <div
                    class="grid grid-cols-12 px-3 py-2 bg-[#151515] text-[10px] text-gray-500 font-semibold border-b border-gray-800 shrink-0">
                    <div class="col-span-5">Name</div>
                    <div class="col-span-3 text-center">Qty</div>
                    <div class="col-span-3 text-right">Value</div>
                    <div class="col-span-1"></div>
                </div>
                <div id="portfolio-list" class="flex-1 overflow-y-auto p-1 space-y-1">
                    <!-- Holdings injected here -->
                </div>
            </div>

            <!-- Footer Summary -->
            <div class="p-4 border-t border-gray-800 bg-[#111] shrink-0 flex flex-col gap-3">
                <div class="flex justify-between items-center gap-4">
                    <div class="flex flex-col">
                        <span class="text-xs text-gray-500">ì¢…ëª© ìˆ˜</span>
                        <span id="pf-count" class="text-lg font-semibold">0</span>
                    </div>
                    <button onclick="clearPortfolio()"
                        class="bg-gray-800/50 hover:bg-red-900/40 text-gray-500 hover:text-red-400 border border-gray-700/50 hover:border-red-800/50 text-xs px-4 py-2 rounded transition flex items-center gap-2">
                        <span>ğŸ—‘ï¸</span> ëª©ë¡ ì´ˆê¸°í™”
                    </button>
                </div>
                <div class="text-xs text-gray-400 text-center border-t border-gray-800/50 pt-2 font-medium">
                    Developed by <span class="text-gray-200">SHIN YONG HUI</span>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-manage" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-[100]">
        <div class="bg-[#1a1a1a] border border-gray-700 rounded-lg w-[380px] p-4 text-gray-200">
            <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                <h3 class="font-bold text-sm">Portfolio Management</h3>
                <button onclick="closeManageModal()" class="text-gray-500 hover:text-white">âœ•</button>
            </div>

            <!-- Save Section -->
            <div class="mb-4">
                <div class="text-[10px] text-gray-500 mb-1">SAVE CURRENT AS</div>
                <div class="flex gap-2">
                    <input type="text" id="save-name-input" placeholder="Name..."
                        class="bg-[#333] border border-gray-600 rounded text-xs px-2 py-1 flex-1 min-w-0 text-white focus:outline-none focus:border-blue-500">
                    <button onclick="saveCurrentPortfolio()"
                        class="bg-blue-600 hover:bg-blue-500 text-white text-xs px-3 py-1 rounded shrink-0">Save</button>
                </div>
            </div>

            <!-- Load Section -->
            <div>
                <div class="text-[10px] text-gray-500 mb-1">SAVED PORTFOLIOS</div>
                <div id="saved-list"
                    class="max-h-[150px] overflow-y-auto space-y-1 border border-gray-800 rounded p-1 bg-[#111]">
                    <div class="text-center text-xs text-gray-600 py-2">Loading...</div>
                </div>
            </div>

            <!-- Import Section -->
            <div class="mt-4 pt-4 border-t border-gray-700">
                <div class="text-[10px] text-gray-500 mb-1">IMPORT PORTFOLIO (CSV Only)</div>
                <div class="flex flex-col gap-2">
                    <div class="flex gap-2">
                        <input type="file" id="import-file-input" accept=".csv,.txt" class="hidden"
                            onchange="importPortfolioFile(this)">
                        <button onclick="document.getElementById('import-file-input').click()"
                            class="bg-gray-700 hover:bg-gray-600 text-gray-200 text-xs px-3 py-2 rounded flex items-center gap-2 w-full justify-center transition">
                            <span>ğŸ“¥</span> Upload CSV
                        </button>
                    </div>

                    <div class="text-[10px] text-gray-500 mt-2 mb-1">EXPORT ACTIVE PORTFOLIO</div>
                    <div class="flex gap-2">
                        <button onclick="exportPortfolio('', 'csv')"
                            class="flex-1 bg-gray-800 hover:bg-gray-700 text-green-400 border border-gray-700 text-xs px-2 py-1.5 rounded transition">
                            <span>ğŸ“¤</span> Export CSV
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- UPDATE RESULT MODAL -->
    <div id="modal-update-result" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-[100]">
        <div class="bg-[#1a1a1a] border border-gray-700 rounded-lg w-[400px] p-6 text-gray-200 shadow-2xl">
            <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                <h3 class="font-bold text-lg text-white">ì—…ë°ì´íŠ¸ ì™„ë£Œ</h3>
                <button onclick="closeUpdateModal()" class="text-gray-500 hover:text-white">âœ•</button>
            </div>

            <div class="space-y-4 mb-6">
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div class="bg-[#222] p-3 rounded">
                        <div class="text-xs text-gray-500">ì´ ì¢…ëª© ìˆ˜</div>
                        <div id="res-total" class="text-xl font-bold text-white">-</div>
                    </div>
                    <div class="bg-[#222] p-3 rounded">
                        <div class="text-xs text-gray-500">ì—…ë°ì´íŠ¸ë¨</div>
                        <div id="res-updated" class="text-xl font-bold text-blue-400">-</div>
                    </div>
                </div>
                <div class="bg-[#2a2a2a] p-3 rounded border border-gray-700">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-xs text-gray-400">ì‹ ê·œ ì¶”ê°€ëœ ETF</span>
                        <span id="res-new-count"
                            class="text-xs font-bold bg-blue-600 px-1.5 rounded text-white">0</span>
                    </div>
                    <div id="res-new-list"
                        class="text-[10px] text-gray-300 h-16 overflow-y-auto w-full break-all leading-relaxed">
                        -
                    </div>
                </div>
            </div>

            <button onclick="closeUpdateModal()"
                class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded transition">í™•ì¸ (í™”ë©´
                ë¦¬í”„ë ˆì‹œ)</button>
        </div>
    </div>

    <!-- CALENDAR MODAL -->
    <div id="modal-calendar"
        class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center backdrop-blur-sm">
        <div
            class="bg-[#111] border border-gray-800 w-[800px] h-[500px] rounded-lg shadow-2xl flex flex-col overflow-hidden">
            <div class="flex justify-between items-center px-4 py-3 border-b border-gray-800 bg-[#1a1a1a]">
                <h3 class="text-sm font-bold text-purple-400 flex items-center gap-2">
                    <span>ğŸ“…</span> ì›”ë³„ ì˜ˆìƒ ë°°ë‹¹ê¸ˆ (Dividend Calendar)
                </h3>
                <button onclick="closeCalendar()" class="text-gray-400 hover:text-white">âœ•</button>
            </div>
            <div class="flex-1 p-6 flex flex-col relative bg-[#111]">
                <div class="absolute top-4 right-4 text-[10px] text-gray-500">
                    * ê³¼ê±° ë°°ë‹¹ ì§€ê¸‰ì›” ê¸°ë°˜ ì¶”ì • (ì •í™•í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ)
                </div>
                <div class="w-full h-full">
                    <canvas id="chart-calendar"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- ANALYSIS MODAL -->
    <div id="modal-analysis"
        class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center backdrop-blur-sm">
        <div
            class="bg-[#111] border border-gray-800 w-[600px] h-[500px] rounded-lg shadow-2xl flex flex-col overflow-hidden">
            <div class="flex justify-between items-center px-4 py-3 border-b border-gray-800 bg-[#1a1a1a]">
                <h3 class="text-sm font-bold text-blue-400 flex items-center gap-2">
                    <span>ğŸ°</span> í¬íŠ¸í´ë¦¬ì˜¤ ì„¹í„° ë¶„ì„ (Beta)
                </h3>
                <button onclick="closeAnalysis()" class="text-gray-400 hover:text-white">âœ•</button>
            </div>
            <div class="flex-1 p-6 flex flex-col items-center justify-center relative">
                <div class="absolute top-4 right-4 text-[10px] text-gray-500">
                    * ë°ì´í„° ì—…ë°ì´íŠ¸ í•„ìš” (ì„¹í„° ì •ë³´ ë¯¸ë³´ìœ  ì‹œ 'ê¸°íƒ€'ë¡œ ë¶„ë¥˜)
                </div>
                <div class="w-[80%] h-[80%]">
                    <canvas id="chart-sector"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- ABOUT MODAL -->
    <div id="modal-about"
        class="hidden fixed inset-0 bg-black/90 z-[100] flex items-center justify-center backdrop-blur-md">
        <div
            class="bg-[#111] border border-gray-800 w-[450px] rounded-2xl shadow-2xl flex flex-col overflow-hidden transform transition-all scale-100 p-8 text-center ring-1 ring-white/10">
            <div class="mb-6 flex justify-center">
                <div
                    class="w-16 h-16 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl flex items-center justify-center shadow-lg shadow-blue-500/20">
                    <span class="text-3xl">ğŸ“ˆ</span>
                </div>
            </div>

            <h2 class="text-3xl font-black text-white mb-2 tracking-tight">KR ETF Dividend Insight</h2>
            <p class="text-blue-400 text-sm font-black mb-6 tracking-[0.2em] uppercase">Version 1.0.1 (Stable)</p>

            <div class="space-y-4 text-base text-gray-400 mb-8 px-4">
                <div class="flex justify-between border-b border-gray-800 pb-3">
                    <span class="text-gray-500">Developer</span>
                    <span class="text-white font-black text-lg">SHIN YONG HUI</span>
                </div>
                <div class="flex justify-between border-b border-gray-800 pb-2">
                    <span class="text-gray-500">License</span>
                    <span class="text-gray-200 font-semibold">Personal Use Only</span>
                </div>
                <div class="flex justify-between border-b border-gray-800 pb-2">
                    <span class="text-gray-500">Framework</span>
                    <span class="text-gray-200 font-semibold">Python Flask & Chart.js</span>
                </div>
            </div>

            <div
                class="bg-[#1a1a1a] border border-gray-800 p-4 rounded-xl text-[10px] text-gray-500 text-left mb-8 leading-relaxed italic">
                "ì´ í”„ë¡œê·¸ë¨ì€ íˆ¬ì ë³´ì¡° ë„êµ¬ì¼ ë¿ì´ë©°, ì œê³µë˜ëŠ” ëª¨ë“  ë°ì´í„°ëŠ” ì‹¤ì œ ì‹œì¥ ìƒí™©ê³¼ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ëª¨ë“  íˆ¬ìì˜ ì±…ì„ì€ ë³¸ì¸ì—ê²Œ ìˆìŠµë‹ˆë‹¤."
            </div>

            <div class="flex flex-col gap-3">
                <button onclick="openManual()"
                    class="w-full bg-blue-900/40 hover:bg-blue-900/60 text-blue-400 border border-blue-900/50 text-sm py-2 rounded-lg transition flex items-center justify-center gap-2">
                    <span>ğŸ“–</span> ì‚¬ìš©ì ë§¤ë‰´ì–¼ ì—´ê¸°
                </button>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="closeAbout()"
                        class="bg-gray-800 hover:bg-gray-700 text-white font-bold py-3 rounded-xl transition">
                        Close
                    </button>
                    <button onclick="exitProgram()"
                        class="bg-red-900/20 hover:bg-red-900/40 text-red-500 border border-red-900/30 font-bold py-3 rounded-xl transition">
                        Exit
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function openManual() {
            try {
                await fetch('/api/system/manual', { method: 'POST' });
            } catch (error) {
                console.error("Failed to open manual:", error);
                alert("ë§¤ë‰´ì–¼ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
        }
    </script>

    <!-- SCRIPT -->
    <!-- SIMULATOR MODAL -->
    <div id="modal-simulator"
        class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center backdrop-blur-sm">
        <div
            class="bg-[#111] border border-gray-800 w-[95%] h-[90%] rounded-lg shadow-2xl flex flex-col overflow-hidden">
            <!-- Header -->
            <div class="flex justify-between items-center px-4 py-3 border-b border-gray-800 bg-[#1a1a1a]">
                <h3 class="text-sm font-bold text-green-400 flex items-center gap-2">
                    <span>ğŸ“ˆ</span> ë°°ë‹¹ ì¬íˆ¬ì ì‹œë®¬ë ˆì´í„°
                </h3>
                <button onclick="closeSimulator()" class="text-gray-400 hover:text-white">âœ•</button>
            </div>

            <!-- Body -->
            <div class="flex flex-1 overflow-hidden">
                <!-- Left: Inputs -->
                <div
                    class="w-[300px] border-r border-gray-800 bg-[#151515] p-4 overflow-y-auto shrink-0 flex flex-col gap-4">
                    <div class="space-y-3">
                        <div>
                            <label class="block text-[10px] text-gray-500 mb-1">ì´ˆê¸° íˆ¬ìê¸ˆ (ì›)</label>
                            <input type="number" id="sim-principal" value="150000000"
                                class="w-full bg-[#222] text-gray-200 border border-gray-700 rounded px-2 py-1 text-xs focus:border-green-500">
                        </div>
                        <div>
                            <label class="block text-[10px] text-gray-500 mb-1">ì›” ì¶”ê°€ íˆ¬ìê¸ˆ (ì›)</label>
                            <input type="number" id="sim-monthly" value="500000"
                                class="w-full bg-[#222] text-gray-200 border border-gray-700 rounded px-2 py-1 text-xs focus:border-green-500">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-[10px] text-gray-500 mb-1">ì—° ë°°ë‹¹ë¥  (%)</label>
                                <input type="number" id="sim-yield" value="10" step="0.1"
                                    class="w-full bg-[#222] text-gray-200 border border-gray-700 rounded px-2 py-1 text-xs">
                            </div>
                            <div>
                                <label class="block text-[10px] text-gray-500 mb-1">ì—° ì£¼ê°€ìƒìŠ¹ (%)</label>
                                <input type="number" id="sim-growth" value="10" step="0.1"
                                    class="w-full bg-[#222] text-gray-200 border border-gray-700 rounded px-2 py-1 text-xs">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-[10px] text-gray-500 mb-1">ë°°ë‹¹ ì„±ì¥ë¥  (%)</label>
                                <input type="number" id="sim-div-growth" value="0" step="0.1"
                                    class="w-full bg-[#222] text-gray-200 border border-gray-700 rounded px-2 py-1 text-xs">
                            </div>
                            <div>
                                <label class="block text-[10px] text-gray-500 mb-1">ë¬¼ê°€ìƒìŠ¹ë¥  (%)</label>
                                <input type="number" id="sim-inflation" value="0" step="0.1"
                                    class="w-full bg-[#222] text-gray-200 border border-gray-700 rounded px-2 py-1 text-xs focus:border-green-500">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-[10px] text-gray-500 mb-1">ì„¸ìœ¨ (%)</label>
                                <input type="number" id="sim-tax" value="15.4" step="0.1"
                                    class="w-full bg-[#222] text-gray-200 border border-gray-700 rounded px-2 py-1 text-xs">
                            </div>
                        </div>
                        <div>
                            <label class="block text-[10px] text-gray-500 mb-1">ë°°ë‹¹ ì¬íˆ¬ì ë¹„ìœ¨ (%)</label>
                            <input type="range" id="sim-reinvest-ratio" min="0" max="100" value="100"
                                class="w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                            <div class="text-right text-[10px] text-green-400 font-bold" id="sim-reinvest-val">100%
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-[10px] text-gray-500 mb-1">ê¸°ê°„ (ë…„)</label>
                                <input type="number" id="sim-years" value="10"
                                    class="w-full bg-[#222] text-gray-200 border border-gray-700 rounded px-2 py-1 text-xs">
                            </div>
                            <div>
                                <label class="block text-[10px] text-gray-500 mb-1">ëª©í‘œ ì›” ë°°ë‹¹ (ì›)</label>
                                <input type="number" id="sim-target" value="5000000"
                                    class="w-full bg-[#222] text-gray-200 border border-gray-700 rounded px-2 py-1 text-xs">
                            </div>
                        </div>
                    </div>

                    <button onclick="runSimulation()"
                        class="mt-4 bg-green-600 hover:bg-green-500 text-white font-bold py-2 rounded text-sm transition shadow-lg shadow-green-900/20">
                        â–¶ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘
                    </button>

                    <button onclick="exportSimulationCSV()" id="btn-sim-csv"
                        class="mt-2 bg-gray-700 hover:bg-gray-600 text-gray-300 py-2 rounded text-xs transition"
                        disabled>
                        ğŸ“ CSV ì €ì¥ (ì‹¤í–‰ í›„ ê°€ëŠ¥)
                    </button>
                </div>

                <!-- Right: Visualization -->
                <div class="flex-1 flex flex-col bg-[#0a0a0a] min-w-0">
                    <!-- Charts -->
                    <div class="h-[50%] p-4 border-b border-gray-800 flex gap-4 min-w-0">
                        <div class="flex-1 bg-[#151515] rounded border border-gray-800 p-2 relative min-w-0">
                            <canvas id="chart-sim-asset"></canvas>
                        </div>
                    </div>

                    <!-- Table & Log -->
                    <div class="flex-1 p-4 overflow-hidden flex flex-col">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-xs font-bold text-gray-400">ìƒì„¸ ë°ì´í„° (ì›”ë³„)</h4>
                            <div class="text-[10px] text-gray-500" id="sim-status">ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
                        </div>
                        <div class="flex-1 overflow-auto border border-gray-800 rounded bg-[#111]">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-[#222] text-[10px] text-gray-400 sticky top-0">
                                    <tr>
                                        <th class="p-2 font-medium">ê¸°ê°„</th>
                                        <th class="p-2 font-medium text-right">ì´ìì‚°</th>
                                        <th class="p-2 font-medium text-right text-orange-400">ì›”ë°°ë‹¹</th>
                                        <th class="p-2 font-medium text-right">ì¬íˆ¬ì</th>
                                        <th class="p-2 font-medium text-right">í˜„ê¸ˆìˆ˜ì·¨</th>
                                        <th class="p-2 font-medium text-right text-gray-500">ëˆ„ì ì›ê¸ˆ</th>
                                        <th class="p-2 font-medium text-right text-green-500">ëˆ„ì ìˆ˜ìµ</th>
                                    </tr>
                                </thead>
                                <tbody id="table-sim-body" class="text-[11px] text-gray-300 divide-y divide-gray-800">
                                    <!-- Dynamic Rows -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let universe = [];
        let portfolio = {};
        let currentTicker = null;
        let chart = null;
        let isDetailOpen = false;
        let currentSort = 'yield'; // Default

        // Optimization: Debounce storage
        let saveTimeout = null;
        let pendingSaves = new Map(); // symbol -> qty

        const elUniverseList = document.getElementById('universe-list');
        const elPortfolioList = document.getElementById('portfolio-list');
        let portfolioHistory = {};
        let pfChart = null;
        let currentPfView = 'list'; // 'list' or 'trend'

        // Initial Load
        window.addEventListener('DOMContentLoaded', async () => {
            updateLayout(); // Set initial layout
            await Promise.all([loadUniverse(), loadPortfolio()]);
            renderUniverse();
            renderPortfolio();
            renderKPI();



            // Check initial update status
            checkUpdateStatus();

            // Click outside to close sort menu
            document.addEventListener('click', (e) => {
                const menu = document.getElementById('sort-menu');
                const btn = document.getElementById('sort-btn');
                if (menu && !menu.classList.contains('hidden')) {
                    if (!menu.contains(e.target) && !btn.contains(e.target)) {
                        menu.classList.add('hidden');
                    }
                }
            });

            // Scroll Listener for Top Button
            const btnScroll = document.getElementById('btn-scroll-top');
            if (btnScroll && elUniverseList) {
                elUniverseList.addEventListener('scroll', () => {
                    if (elUniverseList.scrollTop > 300) {
                        btnScroll.classList.remove('opacity-0', 'pointer-events-none');
                    } else {
                        btnScroll.classList.add('opacity-0', 'pointer-events-none');
                    }
                });
            }
        });

        // -----------------------
        // Layout Logic
        // -----------------------
        // Default widths (Percentages)
        // Default widths (Percentages)
        let wLeft = 25, wCenter = 40; // Right fills remaining
        let wLeft2 = 65; // Right fills remaining

        function updateLayout() {
            const left = document.getElementById('panel-left');
            const center = document.getElementById('panel-center');
            const right = document.getElementById('panel-right');
            const splitter2 = document.getElementById('splitter-2');
            const header = document.getElementById('list-header');

            if (isDetailOpen) {
                // 3-Column Mode
                left.style.display = 'flex';
                center.style.display = 'flex';
                splitter2.style.display = 'flex';

                // Prevent shrinking
                left.style.flex = 'none';
                center.style.flex = 'none';

                left.style.width = wLeft + '%';
                center.style.width = wCenter + '%';
                right.style.flex = '1';

                // Compact Header
                header.className = "grid grid-cols-12 px-2 py-1 bg-[#151515] text-[10px] text-gray-500 font-semibold border-b border-gray-800 items-center";
                header.innerHTML = `
                    <div class="col-span-8 pl-1">Name</div>
                    <div class="col-span-4 text-right">Yield</div>
                `;
            } else {
                // 2-Column Mode
                left.style.display = 'flex';
                center.style.display = 'none';
                splitter2.style.display = 'none';

                // Prevent shrinking
                left.style.flex = 'none';

                left.style.width = wLeft2 + '%';
                right.style.flex = '1';

                // Full Header
                header.className = "grid grid-cols-12 px-4 py-2 bg-[#151515] text-[10px] text-gray-500 font-semibold border-b border-gray-800 items-center";
                header.innerHTML = `
                    <div class="col-span-4 pl-1">Name</div>
                    <div class="col-span-2 text-right">Price</div>
                    <div class="col-span-4 text-center">Return (1M / 3M / 6M / 1Y)</div>
                    <div class="col-span-2 flex justify-end gap-3 text-right">
                        <span class="flex-1">Yield</span>
                        <div class="w-8"></div> <!-- Spacer for Add Button alignment -->
                    </div>
                `;
            }

            renderUniverse();
        }

        // Scroll to Top Logic
        function scrollToTop() {
            const list = document.getElementById('universe-list');
            list.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Resizing Logic
        const container = document.querySelector('.flex-1.flex.overflow-hidden.relative'); // Corrected selector
        const s1 = document.getElementById('splitter-1');
        const s2 = document.getElementById('splitter-2');

        let isResizing = false;
        let currentSplitter = null;

        [s1, s2].forEach(s => {
            s.addEventListener('mousedown', (e) => {
                isResizing = true;
                currentSplitter = e.target.closest('div[id^="splitter"]');
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
            });
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;

            const totalW = container.clientWidth;
            const x = e.clientX;
            const xPct = (x / totalW) * 100;

            if (currentSplitter.id === 'splitter-1') {
                if (isDetailOpen) {
                    if (xPct < 15 || xPct > 45) return;
                    wLeft = xPct;
                    // Center width remains constant? Or we push center?
                    // Better UX: resize Left, Center shifts.
                } else {
                    if (xPct < 20 || xPct > 80) return;
                    wLeft2 = xPct;
                }
            } else if (currentSplitter.id === 'splitter-2') {
                if (!isDetailOpen) return;
                // Center Width = xPct - wLeft
                let newCenter = xPct - wLeft;
                if (newCenter < 20 || (wLeft + newCenter) > 85) return;
                wCenter = newCenter;
            }
            updateLayout();
        });

        document.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
            }
        });

        function openDetail(symbol) {
            currentTicker = symbol;
            isDetailOpen = true;
            updateLayout();
            renderDetail(symbol);
        }

        function closeDetail() {
            isDetailOpen = false;
            currentTicker = null;
            updateLayout();
        }

        function closeUpdateModal() {
            document.getElementById('modal-update-result').classList.add('hidden');
            // Auto Refresh Data
            location.reload();
        }

        function openAbout() {
            document.getElementById('modal-about').classList.remove('hidden');
        }

        function closeAbout() {
            document.getElementById('modal-about').classList.add('hidden');
        }

        async function exitProgram() {
            if (!confirm("í”„ë¡œê·¸ë¨ì„ ì™„ì „íˆ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            try {
                const response = await fetch('/api/system/shutdown', { method: 'POST' });
                const result = await response.json();
                if (result.status === 'shutting_down') {
                    document.body.innerHTML = `
                        <div class="h-screen flex items-center justify-center bg-black text-gray-400 p-8 text-center">
                            <div>
                                <h1 class="text-2xl font-bold text-white mb-4">Shutting Down...</h1>
                                <p>í”„ë¡œê·¸ë¨ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì°½ì„ ë‹«ìœ¼ì…”ë„ ë©ë‹ˆë‹¤.</p>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error("Shutdown failed:", error);
                alert("ì¢…ë£Œ ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        }

        // -----------------------
        // System Update Logic
        // -----------------------
        let updatePollInterval = null;

        async function triggerUpdate() {
            if (!confirm('ë°ì´í„° ì—…ë°ì´íŠ¸ë¥¼ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ìˆ˜ ë¶„ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤)')) return;

            const btn = document.getElementById('btn-update-data');
            try {
                btn.disabled = true;
                btn.innerHTML = '<span>â³</span> Starting...';

                const res = await fetch('/api/system/update?full=true', { method: 'POST' });
                const data = await res.json();

                if (res.status === 409) {
                    alert('ì´ë¯¸ ì—…ë°ì´íŠ¸ê°€ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.');
                }

                checkUpdateStatus(); // Start polling

            } catch (e) {
                console.error(e);
                alert('ì—…ë°ì´íŠ¸ ì‹œì‘ ì‹¤íŒ¨');
                btn.disabled = false;
                btn.innerHTML = '<span>ğŸ”„</span> Update Data';
            }
        }

        let wasRunning = false;

        async function checkUpdateStatus() {
            const btn = document.getElementById('btn-update-data');

            // Ensure we don't stack intervals
            if (updatePollInterval) clearInterval(updatePollInterval);

            // Initial check immediately
            try {
                const res = await fetch('/api/system/status');
                const status = await res.json();
                if (status.is_running) {
                    wasRunning = true; // Mark that we saw it running
                    updateBtnState(btn, status);
                } else {
                    // Not running on load. Check if we missed it?
                    // If we just loaded and it's done, we don't show modal to avoid loop.
                    resetBtnState(btn);
                    // But if we have an error message remaining?
                    if (status.message && status.message.startsWith('Error')) {
                        // Optional: Show error badge? For now do nothing on load.
                    }
                }
            } catch (e) { console.error(e); }

            updatePollInterval = setInterval(async () => {
                try {
                    const res = await fetch('/api/system/status');
                    const status = await res.json();

                    console.log('Update Status:', status); // Debug log

                    if (status.is_running) {
                        wasRunning = true;
                        updateBtnState(btn, status);
                    } else {
                        // Finished or Idle
                        clearInterval(updatePollInterval);
                        updatePollInterval = null;

                        resetBtnState(btn);

                        // Only show result if we were previously watching it run
                        if (wasRunning) {
                            if (status.summary) {
                                showUpdateResult(status.summary);
                            } else if (status.message && status.message.startsWith('Error')) {
                                alert('ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + status.message);
                            }
                            wasRunning = false; // Reset
                        }
                    }
                } catch (e) {
                    console.error("Status check failed", e);
                }
            }, 2000);
        }

        let isCancelling = false;

        async function cancelUpdate() {
            if (!confirm('ì •ë§ ì—…ë°ì´íŠ¸ë¥¼ ì¤‘ë‹¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            try {
                isCancelling = true;
                const btn = document.getElementById('btn-update-data');
                btn.innerHTML = '<span>ğŸ›‘</span> ì¤‘ë‹¨ ì¤‘...';
                btn.disabled = true;

                const res = await fetch('/api/system/stop_update', { method: 'POST' });
                if (res.ok) {
                    console.log('Cancellation requested');
                }
            } catch (e) {
                console.error(e);
                isCancelling = false;
            }
        }

        function updateBtnState(btn, status) {
            if (isCancelling) return; // Don't override if we actally clicked cancel

            btn.disabled = false; // Allow clicking to cancel
            btn.onclick = cancelUpdate;
            btn.className = "bg-blue-900/50 hover:bg-red-900/30 text-blue-200 hover:text-red-200 text-xs px-3 py-1.5 rounded transition flex items-center gap-2 border border-blue-800 cursor-pointer";
            const pct = status.progress || 0;
            // Show percentage and X icon
            btn.innerHTML = `<span>â³</span> ${status.message || 'Updating...'} ${pct}% <span class="text-[10px] opacity-70 ml-1">(Click to Stop)</span>`;
        }

        function resetBtnState(btn) {
            isCancelling = false;
            btn.disabled = false;
            btn.onclick = triggerUpdate;
            btn.className = "bg-gray-800 hover:bg-gray-700 text-gray-300 text-xs px-3 py-1.5 rounded transition flex items-center gap-2 border border-gray-700";
            btn.innerHTML = '<span>ğŸ”„</span> Update Data';
        }

        function showUpdateResult(summary) {
            console.log('Showing Summary:', summary);
            try {
                document.getElementById('res-total').innerText = summary.total;
                document.getElementById('res-updated').innerText = summary.updated_count;
                document.getElementById('res-new-count').innerText = summary.new_count;

                const listEl = document.getElementById('res-new-list');
                if (summary.new_symbols && summary.new_symbols.length > 0) {
                    listEl.innerText = summary.new_symbols.join(", ");
                } else {
                    listEl.innerText = "ì—†ìŒ";
                }

                document.getElementById('modal-update-result').classList.remove('hidden');
            } catch (e) {
                console.error("Error showing modal:", e);
                alert('ì—…ë°ì´íŠ¸ ì™„ë£Œë˜ì—ˆìœ¼ë‚˜ ê²°ê³¼ í‘œì‹œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // -----------------------
        // API Calls
        // -----------------------
        // Global Lookup Map
        let universeMap = {};

        async function loadUniverse() {
            try {
                const res = await fetch('/api/universe');
                if (!res.ok) throw new Error('API Error');
                universe = await res.json();
                // Build Map for O(1) Access
                universeMap = {};
                universe.forEach(u => universeMap[u.symbol] = u);
            } catch (e) {
                console.error(e);
            }
        }

        async function loadPortfolio() {
            try {
                const res = await fetch('/api/portfolio');
                const data = await res.json();
                portfolio = data.positions || {};
            } catch (e) { console.error(e); portfolio = {}; }
        }

        // Debounce variables for saveToServer (using existing declarations at top)

        async function saveToServer(symbol, qty) {
            // 1. Optimistic Update
            if (qty <= 0) {
                delete portfolio[symbol];
            } else {
                portfolio[symbol] = { qty: qty };
            }

            // Quick render for responsiveness
            // renderPortfolio(); // Optimized: Targeted update
            updatePortfolioItemOptimistic(symbol, qty);
            renderKPI();

            // Refresh Trend if active -> MOVED TO DEBOUNCE
            // if (currentPfView === 'trend') {
            //    renderPortfolioTrend();
            // }

            // Efficiently update only the "Added" state in universe list if it exists
            const listItems = document.querySelectorAll(`[data-symbol="${symbol}"]`);
            // Note: Since renderUniverse is currently simple, we might still need it 
            // but let's try to avoid full render if possible.
            // For now, let's call a lightweight version or just refresh the specific row.
            updateUniverseRowState(symbol);

            // 2. Debounced Save
            pendingSaves.set(symbol, qty);

            if (saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                const entries = Array.from(pendingSaves.entries());
                pendingSaves.clear();

                for (const [s, q] of entries) {
                    try {
                        const res = await fetch('/api/portfolio', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ symbol: s, qty: q })
                        });
                        if (!res.ok) {
                            console.error('Failed to save to server:', s, q);
                        }
                    } catch (e) {
                        console.error('Network error during save:', e);
                    }
                }

                // Final sync to ensure everything is correct?
                // NO! This causes flicker if user clicks again while fetch is pending.
                // We trust our optimistic local state. 
                // Only reload if we really suspect desync (e.g. on page reload or periodic polling).

                // await loadPortfolio();
                // renderPortfolio();
                // renderKPI();
                // renderUniverse();

                if (currentPfView === 'trend') {
                    renderPortfolioTrend();
                }
            }, 500);
        }

        // Targeted DOM Update for Performance
        function updatePortfolioItemOptimistic(symbol, qty) {
            const item = universeMap[symbol];
            if (!item) return;
            const d = item.data;
            const val = d.price * qty;

            let div = document.getElementById(`portfolio-item-${symbol}`);

            if (qty <= 0) {
                if (div) div.remove();
                document.getElementById('pf-count').innerText = Object.keys(portfolio).length;
                return;
            }

            if (div) {
                // Update existing
                const input = div.querySelector('input');
                if (input) input.value = qty;

                // Update value display
                const valDiv = div.querySelector('.col-span-3.text-right .text-white');
                if (valDiv) valDiv.innerText = `â‚©${val.toLocaleString()}`;

                // Update buttons onclick handlers
                const minusBtn = div.querySelector('button:first-child');
                if (minusBtn) minusBtn.setAttribute('onclick', `saveToServer('${symbol}', ${qty - 1})`);

                const plusBtn = div.querySelector('button:last-child');
                if (plusBtn) plusBtn.setAttribute('onclick', `saveToServer('${symbol}', ${qty + 1})`);

            } else {
                // Create new
                div = document.createElement('div');
                div.className = "grid grid-cols-12 px-3 py-2 text-xs border-b border-[#222] items-center hover:bg-[#1a1a1a]";
                div.id = `portfolio-item-${symbol}`;
                div.innerHTML = getPortfolioItemHTML(symbol, qty, d, val);
                elPortfolioList.appendChild(div);
                document.getElementById('pf-count').innerText = Object.keys(portfolio).length;
            }
        }

        function getPortfolioItemHTML(symbol, qty, d, val) {
            return `
                    <div class="col-span-5">
                        <div class="text-gray-300 font-medium whitespace-normal break-all leading-tight">${d.name}</div>
                        <div class="text-[9px] text-gray-500">${symbol}</div>
                    </div>
                    <div class="col-span-3 text-center">
                        <div class="flex items-center justify-center gap-1">
                            <button onclick="saveToServer('${symbol}', ${qty - 1})" class="w-5 h-5 bg-[#333] hover:bg-[#555] rounded text-white flex items-center justify-center">-</button>
                            <input type="number" 
                                class="w-12 bg-transparent text-center text-gray-300 border border-gray-700 rounded text-xs focus:outline-none focus:border-blue-500 py-0.5"
                                value="${qty}" 
                                onchange="saveToServer('${symbol}', parseInt(this.value) || 0)"
                                onclick="event.stopPropagation()">
                            <button onclick="saveToServer('${symbol}', ${qty + 1})" class="w-5 h-5 bg-[#333] hover:bg-[#555] rounded text-white flex items-center justify-center">+</button>
                        </div>
                    </div>
                    <div class="col-span-3 text-right">
                        <div class="text-white font-medium">â‚©${val.toLocaleString()}</div>
                    </div>
                    <div class="col-span-1 text-right flex justify-end">
                         <button onclick="saveToServer('${symbol}', 0)" class="text-gray-600 hover:text-red-500 p-1" title="ì‚­ì œ">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                              <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                            </svg>
                         </button>
                    </div>
                `;
        }

        // Helper to update only the specific row in universe list
        function updateUniverseRowState(symbol) {
            const isInPf = portfolio[symbol] && portfolio[symbol].qty > 0;

            // Optimization: Use ID lookup for O(1)
            const listRow = document.getElementById(`universe-row-${symbol}`);
            if (listRow) {
                const bgClass = isInPf ? 'bg-[#121621] hover:bg-[#1a2030]' : 'hover:bg-[#151515]';
                listRow.className = `grid grid-cols-12 px-4 py-4 border-b border-[#222] items-center cursor-pointer transition group ${bgClass}`;

                const nameDiv = listRow.querySelector('.font-bold');
                if (nameDiv) {
                    const existingBadge = nameDiv.querySelector('.bg-blue-900\\/40');
                    if (isInPf && !existingBadge) {
                        nameDiv.insertAdjacentHTML('beforeend', '<span class="ml-2 text-[10px] px-1.5 py-0.5 rounded bg-blue-900/40 text-blue-300 font-normal">ë³´ìœ ì¤‘</span>');
                    } else if (!isInPf && existingBadge) {
                        existingBadge.remove();
                    }
                }
                const addBtn = listRow.querySelector('button');
                if (addBtn) {
                    if (isInPf) {
                        addBtn.classList.add('bg-blue-600', 'text-white');
                        addBtn.classList.remove('bg-[#222]', 'text-gray-400');
                    } else {
                        addBtn.classList.remove('bg-blue-600', 'text-white');
                        addBtn.classList.add('bg-[#222]', 'text-gray-400');
                    }
                }
            }

            // Compact/Detail View rows usually don't have ID, fallback or iterate?
            // Usually Detail view is handled by re-render if open.
            // Let's keep the querySelectorAll for GENERIC usage if we want coverage,
            // OR assumes Detail View updates via other means.
            // Compact view rows... ID was added to WIDE view.
            // Let's add ID to Compact view too if needed.
            // But Compact view is usually Detail Open.
            // Let's stick to efficient ID lookup for the MAIN list.
            // If Detail is open, we can just re-render row of list if visible.
        }

        // -----------------------
        // Render Logic
        // -----------------------
        // Helper: Number Safety
        function num(v) { const n = Number(v); return Number.isFinite(n) ? n : 0; }

        // Helper: Annual Yield Priority Logic
        function annualYieldValue(d) {
            if (d.dist_warning) return 0;
            if (d.dist_ttm_yield > 0) return d.dist_ttm_yield;
            if (d.est_annual_yield > 0) return d.est_annual_yield;
            return 0;
        }


        function formatVal(num) { return `â‚©${Math.round(num).toLocaleString()}`; }
        function getColorClass(val) {
            if (val > 0) return 'text-up';
            if (val < 0) return 'text-down';
            return 'text-gray-500';
        }

        function renderReturn(val, pricePast) {
            if (pricePast === 0 || pricePast === undefined) {
                return `<span class="text-gray-600">-</span>`;
            }
            return `<span class="font-bold ${getColorClass(val)}">${val.toFixed(1)}%</span>`;
        }

        function renderReturnDetail(val, pricePast) {
            if (pricePast === 0 || pricePast === undefined) {
                return `<span class="text-gray-600">-</span>`;
            }
            return `<span class="font-bold ${getColorClass(val)}">${val.toFixed(2)}%</span>`;
        }

        // -----------------------
        // Sort Helpers
        // -----------------------
        function toggleSortMenu() {
            const menu = document.getElementById('sort-menu');
            menu.classList.toggle('hidden');
        }

        function setSort(key) {
            currentSort = key;
            const labels = {
                'name': 'ì´ë¦„ìˆœ',
                'yield': 'ì—°ë¶„ë°°ìœ¨ ë†’ì€ìˆœ',
                'total_return_1y': 'ì´ìˆ˜ìµ 1Y ë†’ì€ìˆœ',
                'return_1y': 'ê°€ê²©ìƒìŠ¹ 1Y ë†’ì€ìˆœ'
            };
            document.getElementById('current-sort-label').innerText = labels[key];
            toggleSortMenu();
            renderUniverse();
        }

        function renderUniverse() {
            // Filter & Sort logic
            const search = document.getElementById('search-input').value.toLowerCase();

            let filtered = universe.filter(item => {
                const d = item.data;
                const nameMatch = d.name.toLowerCase().includes(search) || item.symbol.includes(search);
                if (!nameMatch) return false;
                return true;
            });

            filtered.sort((a, b) => {
                const da = a.data;
                const db = b.data;

                if (currentSort === 'yield') {
                    // income_yield_annual_used implements the Priority Logic (TTM > Est)
                    return annualYieldValue(db) - annualYieldValue(da);
                } else if (currentSort === 'total_return_1y') {
                    return (db.total_return_1y || 0) - (da.total_return_1y || 0);
                } else if (currentSort === 'return_1y') {
                    return (db.return_1y || 0) - (da.return_1y || 0);
                } else if (currentSort === 'name') {
                    return da.name.localeCompare(db.name);
                }
                return 0;
            });

            elUniverseList.innerHTML = '';
            filtered.forEach(item => {
                const d = item.data;
                const isSel = currentTicker === item.symbol;
                const isInPf = portfolio[item.symbol] && portfolio[item.symbol].qty > 0;

                const div = document.createElement('div');
                div.onclick = () => openDetail(item.symbol);

                if (isDetailOpen) {
                    // COMPACT MODE (3-Column)
                    let bgClass = '';
                    if (isSel) {
                        bgClass = 'bg-[#222] border-l-2 border-l-blue-500';
                    } else if (isInPf) {
                        bgClass = 'bg-[#151c2f] border-l-2 border-l-blue-900/40';
                    }

                    div.className = `grid grid-cols-12 px-2 py-3 text-xs border-b border-[#222] items-center cursor-pointer hover:bg-[#1a1a1a] transition ${bgClass}`;
                    div.innerHTML = `
                        <div class="col-span-8 pl-1">
                            <div class="font-bold text-gray-300 whitespace-normal break-all leading-tight">
                                ${d.name}
                                ${isInPf ? '<span class="text-[9px] text-blue-500 ml-1">â—</span>' : ''}
                            </div>
                            <div class="text-[9px] text-gray-600">${item.symbol}</div>
                        </div>
                        <div class="col-span-4 text-right">
                            ${renderYieldMini(d)}
                        </div>
                    `;
                } else {
                    // WIDE MODE (2-Column)
                    const bgClass = isInPf ? 'bg-[#121621] hover:bg-[#1a2030]' : 'hover:bg-[#151515]';

                    div.className = `grid grid-cols-12 px-4 py-4 border-b border-[#222] items-center cursor-pointer transition group ${bgClass}`;
                    div.setAttribute('data-symbol', item.symbol);
                    div.id = `universe-row-${item.symbol}`; // Optimization: ID for O(1) lookup

                    div.innerHTML = `
                        <!-- Name & Ticker -->
                        <div class="col-span-4">
                            <div class="font-bold text-base text-gray-200 whitespace-normal break-all leading-snug group-hover:text-blue-400 transition">
                                ${d.name}
                                ${isInPf ? '<span class="ml-2 text-[10px] px-1.5 py-0.5 rounded bg-blue-900/40 text-blue-300 font-normal">ë³´ìœ ì¤‘</span>' : ''}
                            </div>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-xs text-gray-500">${item.symbol}</span>
                                ${d.dist_warning ? '<span class="badge-warn text-yellow-500 text-[10px] cursor-help border border-yellow-500 rounded px-1" title="FnGuide ë°ì´í„° ë¯¸ì œê³µ/íˆìŠ¤í† ë¦¬ íŒŒì‹± ì‹¤íŒ¨/ì‹ ê·œ ìƒì¥ ë“±" onclick="event.stopPropagation(); alert(\'FnGuide ë°ì´í„° ë¯¸ì œê³µ/íˆìŠ¤í† ë¦¬ íŒŒì‹± ì‹¤íŒ¨/ì‹ ê·œ ìƒì¥ ë“±\')">ì •ë³´ì—†ìŒ</span>' : ''}
                            </div>
                        </div>

                        <!-- Price -->
                        <div class="col-span-2 text-right">
                             <div class="text-sm font-bold text-white">${d.price.toLocaleString()}</div>
                             <div class="text-[10px] text-gray-500">KRW</div>
                        </div>

                        <div class="col-span-4 grid grid-cols-4 gap-2 text-center items-center">
                            <div class="flex flex-col">
                                <span class="text-[10px] text-gray-600">1M</span>
                                ${renderReturn(d.return_1m, d.price_1m)}
                            </div>
                            <div class="flex flex-col">
                                <span class="text-[10px] text-gray-600">3M</span>
                                ${renderReturn(d.return_3m, d.price_3m)}
                            </div>
                             <div class="flex flex-col">
                                <span class="text-[10px] text-gray-600">6M</span>
                                ${renderReturn(d.return_6m, d.price_6m)}
                            </div>
                             <div class="flex flex-col">
                                <span class="text-[10px] text-gray-600">1Y</span>
                                ${renderReturn(d.return_1y, d.price_1y)}
                            </div>
                        </div>

                        <!-- Yield & Add Btn -->
                        <div class="col-span-2 text-right flex items-center justify-end gap-3">
                            <div class="text-right">
                                ${renderYieldRight(d)}
                            </div>
                            <button onclick="event.stopPropagation(); addToPortfolio('${item.symbol}')" class="w-8 h-8 rounded-full ${isInPf ? 'bg-blue-600 text-white' : 'bg-[#222] hover:bg-blue-600 text-gray-400 hover:text-white'} flex items-center justify-center transition" title="${isInPf ? 'ì¶”ê°€ ë§¤ìˆ˜' : 'í¬íŠ¸í´ë¦¬ì˜¤ ì¶”ê°€'}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                            </button>
                        </div>
                    `;
                }
                elUniverseList.appendChild(div);
            });
        }

        function addToPortfolio(symbol) {
            // Quick Add +10 to current qty or init 1
            const current = portfolio[symbol] ? portfolio[symbol].qty : 0;
            const toAdd = current === 0 ? 10 : 1;
            saveToServer(symbol, current + toAdd);
        }

        function renderYieldMini(d) {
            if (d.dist_ttm_yield > 0) {
                return `<div class="text-yield font-bold">${d.dist_ttm_yield.toFixed(2)}%</div>`;
            } else if (d.est_annual_yield > 0) {
                return `<div class="text-gray-400 font-bold">${d.est_annual_yield.toFixed(2)}%(E)</div>`;
            }
            return `<div class="text-gray-600">-</div>`;
        }

        function renderYieldRight(d) {
            if (d.dist_ttm_yield > 0) {
                return `
                    <div class="text-sm font-bold text-white">ì—° ${d.dist_ttm_yield.toFixed(2)}%</div>
                    <div class="flex items-center justify-end gap-1">
                        <span class="text-[9px] px-1 py-0.5 rounded bg-green-900 text-green-300 font-bold">TTM</span>
                    </div>
                `;
            } else if (d.est_annual_yield > 0) {
                return `
                    <div class="text-sm font-bold text-white">ì—° ${d.est_annual_yield.toFixed(2)}%</div>
                     <div class="flex items-center justify-end gap-1">
                        <span class="text-[9px] px-1 py-0.5 rounded bg-gray-700 text-gray-300 font-bold">ì¶”ì •</span>
                    </div>
                `;
            } else {
                return `<div class="text-sm text-gray-600">-</div>`;
            }
        }

        function renderDetail(symbol) {
            const item = universe.find(x => x.symbol === symbol);
            if (!item) return;
            const d = item.data;

            const container = document.getElementById('detail-content');
            container.innerHTML = `
                <!-- Header -->
                <div class="mb-6">
                    <div class="flex items-center gap-2 mb-1">
                         <span class="text-gray-500 text-sm font-mono">${symbol}</span>
                    </div>
                    <h2 class="text-3xl font-bold text-white leading-tight mb-2">${d.name}</h2>
                    <div class="text-4xl font-bold flex items-end gap-2">
                        ${d.price.toLocaleString()} <span class="text-lg text-gray-500 font-normal mb-1">KRW</span>
                    </div>
                </div>

                <!-- Main Yield Card -->
                <div class="glass p-6 rounded-2xl text-center mb-6">
                    <p class="text-gray-400 text-sm uppercase mb-2 font-medium">ì—° ë¶„ë°°ìœ¨ (Annual Yield)</p>
                    <div class="flex flex-col items-center justify-center">
                        ${d.dist_ttm_yield > 0
                    ? `
                                <span class="text-5xl font-extrabold text-yield tracking-tight">${d.dist_ttm_yield.toFixed(2)}%</span>
                                <span class="text-xs text-gray-500 mt-2">TTM (ì§€ë‚œ 12ê°œì›” ë¶„ë°°ê¸ˆ í•©ê³„)</span>
                              `
                    : (d.est_annual_yield > 0
                        ? `
                                    <span class="text-5xl font-extrabold text-gray-300 tracking-tight">${d.est_annual_yield.toFixed(2)}% <span class="text-lg text-gray-500 font-normal">(ì¶”ì •)</span></span>
                                    <span class="text-xs text-gray-500 mt-2">(ìµœê·¼ ë¶„ë°°ê¸ˆ Ã— ì—° ë¶„ë°°íšŸìˆ˜ ê¸°ì¤€)</span>
                                  `
                        : `<span class="text-4xl text-gray-600">-</span>`
                    )
                }
                    </div>
                </div>

                <!-- Info Grid: Monthly Cash Flow & Recent Dist -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="glass p-4 rounded-xl">
                        <span class="text-gray-500 text-xs block mb-1">ì›” í˜„ê¸ˆíë¦„ (ì¶”ì •)</span>
                        <div class="flex items-end gap-1">
                            <span class="text-2xl font-bold text-white">${d.monthly_income_est > 0 ? d.monthly_income_est.toLocaleString() : '-'}</span>
                            <span class="text-xs text-gray-600 mb-1">ì›</span>
                        </div>
                        <span class="text-[10px] text-gray-600 block mt-1">ì—° ë¶„ë°°ê¸ˆ ê¸°ì¤€ ì›” í™˜ì‚°</span>
                    </div>
                    <div class="glass p-4 rounded-xl">
                         <span class="text-gray-500 text-xs block mb-1">ìµœê·¼ 1ë…„ ì´ìˆ˜ìµë¥ </span>
                         <span class="text-xl font-bold">${renderReturnDetail(d.total_return_1y, d.price_1y)}</span>
                         <span class="text-[10px] text-gray-600 block mt-1">ê°€ê²©ìˆ˜ìµ + ë¶„ë°°ìˆ˜ìµ</span>
                    </div>
                </div>
                
                <div class="glass p-5 rounded-xl mb-4">
                     <h3 class="text-gray-400 text-xs uppercase mb-3 border-b border-gray-800 pb-2">ë‹¨ê¸° ê°€ê²© ì„±ê³¼ (Price Return)</h3>
                     <div class="grid grid-cols-4 gap-2 text-center">
                        <div>
                            <span class="text-[10px] text-gray-500 block mb-1">1ê°œì›”</span>
                            ${renderReturnDetail(d.return_1m, d.price_1m)}
                        </div>
                        <div>
                            <span class="text-[10px] text-gray-500 block mb-1">3ê°œì›”</span>
                            ${renderReturnDetail(d.return_3m, d.price_3m)}
                        </div>
                        <div>
                            <span class="text-[10px] text-gray-500 block mb-1">6ê°œì›”</span>
                            ${renderReturnDetail(d.return_6m, d.price_6m)}
                        </div>
                        <div>
                            <span class="text-[10px] text-gray-500 block mb-1">1ë…„</span>
                            ${renderReturnDetail(d.return_1y, d.price_1y)}
                        </div>
                     </div>
                </div>

                <div class="glass p-5 rounded-xl mb-4">
                     <h3 class="text-gray-400 text-xs uppercase mb-3 border-b border-gray-800 pb-2">ì´ ìˆ˜ìµë¥  (Total Return)</h3>
                     <div class="grid grid-cols-3 gap-2 text-center">
                        <div>
                            <span class="text-[10px] text-gray-500 block mb-1">1ë…„</span>
                            ${renderReturnDetail(d.total_return_1y, d.price_1y)}
                        </div>
                        <div>
                            <span class="text-[10px] text-gray-500 block mb-1">3ë…„</span>
                            ${renderReturnDetail(d.total_return_3y, d.price_3y)}
                        </div>
                        <div>
                            <span class="text-[10px] text-gray-500 block mb-1">5ë…„</span>
                            ${renderReturnDetail(d.total_return_5y, d.price_5y)}
                        </div>
                     </div>
                </div>

                <div class="glass p-5 rounded-xl mb-6">
                     <h3 class="text-gray-400 text-xs uppercase mb-3 border-b border-gray-800 pb-2">ì´ ìˆ˜ìµ CAGR (ì—°í‰ê· )</h3>
                     <div class="grid grid-cols-3 gap-2 text-center">
                        <div>
                            <span class="text-[10px] text-gray-500 block mb-1">1ë…„</span>
                            ${renderReturnDetail(d.total_cagr_1y, d.price_1y)}
                        </div>
                        <div>
                            <span class="text-[10px] text-gray-500 block mb-1">3ë…„</span>
                            ${renderReturnDetail(d.total_cagr_3y, d.price_3y)}
                        </div>
                        <div>
                            <span class="text-[10px] text-gray-500 block mb-1">5ë…„</span>
                            ${renderReturnDetail(d.total_cagr_5y, d.price_5y)}
                        </div>
                     </div>
                </div>



                <!-- Portfolio Input -->
                <div class="pt-6 border-t border-gray-800">
                    <label class="block text-sm text-gray-400 mb-3">ë‚´ ë³´ìœ ìˆ˜ëŸ‰ ìˆ˜ì •</label>
                    <div class="flex gap-3">
                        <input type="number" id="d-input-qty" value="${portfolio[symbol] ? portfolio[symbol].qty : 0}" 
                            class="flex-1 bg-[#1a1a1a] border border-gray-700 rounded-lg px-4 py-3 text-white text-lg focus:outline-none focus:border-blue-500" placeholder="0">
                        <button onclick="saveDetailQty('${symbol}')" class="bg-blue-600 hover:bg-blue-500 text-white px-8 rounded-lg font-bold transition">ì €ì¥</button>
                    </div>
                </div>
            `;

            updateChart(d);
        }

        function saveDetailQty(symbol) {
            const val = document.getElementById('d-input-qty').value;
            saveToServer(symbol, parseInt(val) || 0);
        }

        function updateChart(d) {
            const el = document.getElementById('returnChart');
            if (!el) return;
            const ctx = el.getContext('2d');
            if (chart) chart.destroy();
            const trColor = d.total_return_1y >= 0 ? '#ef4444' : '#3b82f6';
            const prColor = d.return_1y >= 0 ? '#fca5a5' : '#93c5fd';
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['ìˆ˜ìµë¥  (1 Year)'],
                    datasets: [
                        { label: 'TR (ì´ìˆ˜ìµ)', data: [d.total_return_1y], backgroundColor: trColor, borderRadius: 4 },
                        { label: 'Price (ê°€ê²©)', data: [d.return_1y], backgroundColor: prColor, borderRadius: 4 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, indexAxis: 'y',
                    plugins: { legend: { position: 'bottom', labels: { color: '#888' } } },
                    scales: { x: { grid: { color: '#333' }, ticks: { color: '#888' } }, y: { display: false } }
                }
            });
        }

        // Render Portfolio (Right Panel)
        function renderPortfolio() {
            elPortfolioList.innerHTML = '';
            let count = 0;
            Object.keys(portfolio).forEach(symbol => {
                const pos = portfolio[symbol];
                const item = universe.find(x => x.symbol === symbol);
                if (!item) return;
                const d = item.data;
                const val = d.price * pos.qty;
                count++;

                const div = document.createElement('div');
                div.className = "grid grid-cols-12 px-3 py-2 text-xs border-b border-[#222] items-center hover:bg-[#1a1a1a]";
                div.id = `portfolio-item-${symbol}`;
                div.innerHTML = `
                    <div class="col-span-5">
                        <div class="text-gray-300 font-medium whitespace-normal break-all leading-tight">${d.name}</div>
                        <div class="text-[9px] text-gray-500">${symbol}</div>
                    </div>
                    <div class="col-span-3 text-center">
                        <div class="flex items-center justify-center gap-1">
                            <button onclick="saveToServer('${symbol}', ${pos.qty - 1})" class="w-5 h-5 bg-[#333] hover:bg-[#555] rounded text-white flex items-center justify-center">-</button>
                            <input type="number" 
                                class="w-12 bg-transparent text-center text-gray-300 border border-gray-700 rounded text-xs focus:outline-none focus:border-blue-500 py-0.5"
                                value="${pos.qty}" 
                                onchange="saveToServer('${symbol}', parseInt(this.value) || 0)"
                                onclick="event.stopPropagation()">
                            <button onclick="saveToServer('${symbol}', ${pos.qty + 1})" class="w-5 h-5 bg-[#333] hover:bg-[#555] rounded text-white flex items-center justify-center">+</button>
                        </div>
                    </div>
                    <div class="col-span-3 text-right">
                        <div class="text-white font-medium">â‚©${val.toLocaleString()}</div>
                    </div>
                    <div class="col-span-1 text-right flex justify-end">
                         <button onclick="saveToServer('${symbol}', 0)" class="text-gray-600 hover:text-red-500 p-1" title="ì‚­ì œ">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                              <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                            </svg>
                         </button>
                    </div>
                `;
                elPortfolioList.appendChild(div);
            });
            document.getElementById('pf-count').innerText = count;
        }

        function renderKPI() {
            let totalVal = 0, monthlyIncome = 0, annualIncome = 0, weightedRetSum = 0;
            Object.keys(portfolio).forEach(symbol => {
                const qty = portfolio[symbol].qty;
                // Use Map for O(1)
                const item = universeMap[symbol];
                if (item && qty > 0) {
                    const d = item.data;
                    const val = d.price * qty;
                    totalVal += val;
                    monthlyIncome += ((num(d.monthly_income_est) || num(d.monthly_income_est_1share)) * qty);
                    annualIncome += (num(d.income_amount_annual_used) * qty);
                    weightedRetSum += (val * num(d.total_return_1y));
                }
            });
            const pfRet = totalVal > 0 ? (weightedRetSum / totalVal) : 0;
            document.getElementById('kpi-total-val').innerText = formatVal(totalVal);
            document.getElementById('kpi-monthly').innerText = formatVal(monthlyIncome);
            document.getElementById('kpi-annual').innerText = formatVal(annualIncome);
            const elRet = document.getElementById('kpi-return');
            elRet.innerText = pfRet.toFixed(2) + '%';
            elRet.className = `font-bold text-lg ${getColorClass(pfRet)}`;
        }

        // -----------------------
        // View Toggle & Trend Logic
        // -----------------------
        function togglePortfolioView(mode) {
            currentPfView = mode;
            const btnList = document.getElementById('btn-pf-list');
            const btnTrend = document.getElementById('btn-pf-trend');
            const viewTrend = document.getElementById('view-portfolio-trend');
            // viewList is always visible now, effectively

            if (mode === 'list') {
                btnList.className = "px-2 py-0.5 text-[10px] rounded bg-gray-600 text-white font-bold transition";
                btnTrend.className = "px-2 py-0.5 text-[10px] rounded text-gray-500 hover:text-white transition";
                viewTrend.classList.add('hidden');
                viewTrend.classList.remove('flex');
            } else {
                btnTrend.className = "px-2 py-0.5 text-[10px] rounded bg-blue-600 text-white font-bold transition";
                btnList.className = "px-2 py-0.5 text-[10px] rounded text-gray-500 hover:text-white transition";
                viewTrend.classList.remove('hidden');
                viewTrend.classList.add('flex');
                renderPortfolioTrend();
            }
        }

        async function renderPortfolioTrend() {
            // Optimization: Only fetch missing tickers
            const tickers = Object.keys(portfolio).filter(k => portfolio[k].qty > 0);
            if (tickers.length === 0) {
                // If no portfolio, clear chart?
                // portfolioHistory = {}; // Don't clear cache aggressively
                return;
            }

            const missing = tickers.filter(t => !portfolioHistory[t]);
            if (missing.length > 0) {
                try {
                    const res = await fetch('/api/history', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ tickers: missing })
                    });
                    if (res.ok) {
                        const newHistory = await res.json();
                        // Merge new history into existing
                        Object.assign(portfolioHistory, newHistory);
                    }
                } catch (e) {
                    console.error("History fetch error:", e);
                }
            }

            // Process Data: Sum(Qty * Price) for each date
            // 1. Collect all dates
            const dateSet = new Set();
            Object.values(portfolioHistory).forEach(hist => {
                hist.forEach(pt => dateSet.add(pt.date));
            });
            const dates = Array.from(dateSet).sort();

            // 2. Build map { date: totalValue }
            // To handle missing dates for some tickers (different holidays?), fill forward or 0.
            // Simple approach: Iterate dates. For each ticker, find price at date (or nearest prev).
            const dataPoints = [];

            // Helper: Find price at date
            const priceMap = {}; // ticker -> current price cursor

            dates.forEach(d => {
                let dailyTotal = 0;
                let valid = false;

                tickers.forEach(t => {
                    const qty = portfolio[t].qty;
                    const hist = portfolioHistory[t] || [];
                    // Simple lookup: hist is list of {date, price}
                    // optimize: convert hist to map? No, just find. Arrays are small (~250).
                    const entry = hist.find(x => x.date === d);
                    if (entry) {
                        priceMap[t] = entry.price;
                        valid = true;
                    }
                    // Use last known price if no entry for today (e.g. trading halt or mismatched date)
                    if (priceMap[t]) {
                        dailyTotal += (priceMap[t] * qty);
                    }
                });

                // If we have at least one valid price update or carry forward
                dataPoints.push(dailyTotal);
            });

            // Graph
            const ctx = document.getElementById('portfolioChart').getContext('2d');
            if (pfChart) pfChart.destroy();

            // Gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(59, 130, 246, 0.5)'); // Blue
            gradient.addColorStop(1, 'rgba(59, 130, 246, 0.0)');

            pfChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Portfolio Value (1Y)',
                        data: dataPoints,
                        borderColor: '#3b82f6',
                        backgroundColor: gradient,
                        borderWidth: 2,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0,0,0,0.9)',
                            titleColor: '#ccc',
                            bodyColor: '#fff',
                            callbacks: {
                                label: function (context) {
                                    return 'â‚©' + Math.round(context.parsed.y).toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: false,
                            grid: { display: false }
                        },
                        y: {
                            display: false,
                            grid: { display: false }
                        }
                    }
                }
            });

            // Update Stats
            if (dataPoints.length > 0) {
                const startVal = dataPoints[0];
                const endVal = dataPoints[dataPoints.length - 1];
                const ret = startVal > 0 ? ((endVal - startVal) / startVal) * 100 : 0;

                document.getElementById('trend-start-val').innerText = formatVal(startVal);
                document.getElementById('trend-end-val').innerText = formatVal(endVal);

                const elRet = document.getElementById('trend-return');
                elRet.innerText = (ret > 0 ? '+' : '') + ret.toFixed(2) + '%';
                elRet.className = `font-bold ${getColorClass(ret)}`;
            }
        }

        // -----------------------
        // Portfolio Management (Save/Load)
        // -----------------------
        const modalManage = document.getElementById('modal-manage');
        const saveNameInput = document.getElementById('save-name-input');
        const savedList = document.getElementById('saved-list');

        function openManageModal() {
            modalManage.classList.remove('hidden');
            loadPortfolioList();
        }

        function closeManageModal() {
            modalManage.classList.add('hidden');
            saveNameInput.value = '';
        }

        async function loadPortfolioList() {
            savedList.innerHTML = '<div class="text-center text-xs text-gray-600 py-2">Loading...</div>';
            try {
                const res = await fetch('/api/portfolio/list');
                const names = await res.json();

                if (names.length === 0) {
                    savedList.innerHTML = '<div class="text-center text-xs text-gray-600 py-2">No saved portfolios</div>';
                    return;
                }

                savedList.innerHTML = '';
                names.forEach(name => {
                    const row = document.createElement('div');
                    row.className = "flex justify-between items-center bg-[#222] p-2 rounded hover:bg-[#2a2a2a] transition group";
                    // Escape single quotes for use in onclick attribute
                    const safeName = name.replace(/'/g, "\\'");
                    row.innerHTML = `
                        <span class="text-xs font-bold text-gray-300 truncate max-w-[120px]" title="${name}">${name}</span>
                        <div class="flex gap-1 opacity-60 group-hover:opacity-100 transition items-center">
                            <button onclick="exportPortfolio('${safeName}', 'csv')" class="text-[9px] px-1 bg-gray-700 text-green-300 rounded" title="Export CSV">CSV</button>
                            <div class="w-px h-3 bg-gray-600 mx-1"></div>
                            <button onclick="loadSavedPortfolio('${safeName}')" class="text-blue-400 hover:text-blue-300 text-[10px] font-bold">LOAD</button>
                            <button onclick="handleDeleteClick(this, '${safeName}')" class="text-red-500 hover:text-red-400 text-[10px]">DEL</button>
                        </div>
                    `;
                    savedList.appendChild(row);
                });
            } catch (e) {
                savedList.innerHTML = '<div class="text-center text-xs text-red-500 py-2">Error loading list</div>';
            }
        }

        async function saveCurrentPortfolio() {
            const name = saveNameInput.value.trim();
            if (!name) { alert('Please enter a name'); return; }

            try {
                const res = await fetch('/api/portfolio/save_as', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                if (res.ok) {
                    saveNameInput.value = '';
                    loadPortfolioList();
                } else {
                    const data = await res.json();
                    alert('Error: ' + (data.error || 'Failed'));
                }
            } catch (e) { alert('Network Error'); }
        }

        async function loadSavedPortfolio(name) {
            console.log('Loading portfolio:', name);
            // Removed confirm to prevent blocking issues
            // if (!confirm(`Load portfolio "${name}"? Current unsaved changes will be lost.`)) return;
            try {
                const res = await fetch('/api/portfolio/load', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                if (res.ok) {
                    closeManageModal();
                    await loadPortfolio();
                    renderPortfolio();
                    renderKPI();
                    if (currentPfView === 'trend') {
                        // Force refresh trend
                        portfolioHistory = {}; // clear cache to force re-fetch for new items
                        renderPortfolioTrend();
                    }
                } else {
                    alert('Load failed');
                }
            } catch (e) { alert('Error loading'); }
        }

        function handleDeleteClick(btn, name) {
            if (btn.innerText === 'DEL') {
                btn.innerText = 'SURE?';
                btn.className = "bg-red-600 text-white text-[10px] px-1 rounded font-bold hover:bg-red-700 transition";
                // Reset after 3 seconds
                setTimeout(() => {
                    if (btn && btn.innerText === 'SURE?') {
                        btn.innerText = 'DEL';
                        btn.className = "text-red-500 hover:text-red-400 text-[10px]";
                    }
                }, 3000);
            } else {
                deleteSavedPortfolio(name);
            }
        }

        async function deleteSavedPortfolio(name) {
            console.log('Deleting portfolio:', name);
            // Removed confirm to prevent blocking issues
            // if (!confirm(`Delete "${name}"?`)) return;
            try {
                const res = await fetch('/api/portfolio/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                if (res.ok) {
                    loadPortfolioList();
                } else {
                    alert('Delete failed');
                }
            } catch (e) { alert('Error deleting'); }
        }

        async function clearPortfolio() {
            if (!confirm('í˜„ í™œì„± í¬íŠ¸í´ë¦¬ì˜¤ì˜ ëª¨ë“  ì¢…ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            try {
                const res = await fetch('/api/portfolio/clear', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (res.ok) {
                    const data = await res.json();
                    portfolio = data.positions || {};
                    renderPortfolio();
                    renderKPI();
                    renderUniverse();
                    if (isDetailOpen) closeDetail();
                    if (currentPfView === 'trend') {
                        portfolioHistory = {};
                        renderPortfolioTrend();
                    }
                    // Inform user
                    alert('í¬íŠ¸í´ë¦¬ì˜¤ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    alert('ì´ˆê¸°í™” ì‹¤íŒ¨');
                }
            } catch (e) { alert('ì˜¤ë¥˜ ë°œìƒ: ' + e.message); }
        }

        // -----------------------
        // Simulator Logic
        // -----------------------
        let simChart = null;
        let lastSimData = null;

        document.getElementById('sim-reinvest-ratio').addEventListener('input', (e) => {
            document.getElementById('sim-reinvest-val').innerText = e.target.value + '%';
        });

        function openSimulator() {
            document.getElementById('modal-simulator').classList.remove('hidden');
        }

        function closeSimulator() {
            document.getElementById('modal-simulator').classList.add('hidden');
        }

        async function runSimulation() {
            const params = {
                initial_principal: parseFloat(document.getElementById('sim-principal').value) || 0,
                monthly_invest: parseFloat(document.getElementById('sim-monthly').value) || 0,
                annual_yield: (parseFloat(document.getElementById('sim-yield').value) || 0) / 100,
                growth_rate: (parseFloat(document.getElementById('sim-growth').value) || 0) / 100,
                annual_div_growth: (parseFloat(document.getElementById('sim-div-growth').value) || 0) / 100,
                inflation_rate: (parseFloat(document.getElementById('sim-inflation').value) || 0) / 100,
                tax_rate: (parseFloat(document.getElementById('sim-tax').value) || 0) / 100,
                reinvest_ratio: (() => {
                    const val = document.getElementById('sim-reinvest-ratio').value;
                    return (val === '' ? 100 : parseFloat(val)) / 100;
                })(),
                years: parseInt(document.getElementById('sim-years').value) || 10,
                target_div: parseFloat(document.getElementById('sim-target').value) || 0
            };

            const btn = document.querySelector('#modal-simulator button[onclick="runSimulation()"]');
            const originalText = btn.innerText;
            btn.innerText = "ê³„ì‚° ì¤‘...";
            btn.disabled = true;

            try {
                const res = await fetch('/api/simulate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params)
                });
                const data = await res.json();
                lastSimData = data;

                renderSimResults(data, params);
                document.getElementById('btn-sim-csv').disabled = false;
                document.getElementById('btn-sim-csv').classList.replace('text-gray-300', 'text-white');
                document.getElementById('btn-sim-csv').classList.replace('bg-gray-700', 'bg-blue-600');

            } catch (e) {
                alert("Simulation Error: " + e.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        function renderSimResults(history, params) {
            // Update Status
            const final = history[history.length - 1];
            if (final) {
                let statusHtml = `<span class="text-green-400">ìµœì¢… ìì‚°: ${formatVal(final.asset_post)}ì›</span> | ` +
                    `<span class="text-orange-400">ìµœì¢… ì›”ë°°ë‹¹: ${formatVal(final.monthly_div_post)}ì›</span>`;

                if (params.inflation_rate > 0) {
                    statusHtml += ` <span class="text-gray-500 text-[10px] ml-2">(ì‹¤ì§ˆê°€ì¹˜: ${formatVal(final.asset_post_real)}ì› / ì›” ${formatVal(final.monthly_div_post_real)}ì›)</span>`;
                }
                document.getElementById('sim-status').innerHTML = statusHtml;
            }

            // Render Table
            const tbody = document.getElementById('table-sim-body');
            tbody.innerHTML = '';

            let maxRows = 240;

            history.forEach((row, idx) => {
                if (idx >= 600) return; // Limit table rows for safety

                // Highlighting
                const tr = document.createElement('tr');
                tr.className = "hover:bg-[#2a2a2a] transition";

                // Check target
                let targetHit = false;
                if (params.target_div > 0 && row.monthly_div_post >= params.target_div && (!history[idx - 1] || history[idx - 1].monthly_div_post < params.target_div)) {
                    tr.style.backgroundColor = "rgba(40, 167, 69, 0.2)";
                    targetHit = true;
                }

                tr.innerHTML = `
                <td class="p-2 border-b border-gray-800">${row.period}</td>
                <td class="p-2 border-b border-gray-800 text-right">${formatVal(row.asset_post)}</td>
                <td class="p-2 border-b border-gray-800 text-right text-orange-300">${formatVal(row.monthly_div_post)}</td>
                <td class="p-2 border-b border-gray-800 text-right text-gray-400">${formatVal(row.reinvest_post)}</td>
                <td class="p-2 border-b border-gray-800 text-right text-gray-500">${formatVal(row.cash_div_post)}</td>
                <td class="p-2 border-b border-gray-800 text-right text-gray-600">${formatVal(row.principal_post)}</td>
                <td class="p-2 border-b border-gray-800 text-right ${row.asset_post - row.principal_post > 0 ? 'text-green-400' : 'text-red-400'}">
                    ${formatVal(row.asset_post - row.principal_post)}
                </td>
               `;
                tbody.appendChild(tr);

                if (targetHit) {
                    tr.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            });

            // Render Chart
            const ctx = document.getElementById('chart-sim-asset').getContext('2d');
            if (simChart) simChart.destroy();

            const labels = history.map(r => r.period);
            const dataPrincipal = history.map(r => r.principal_post);
            const dataDivCum = history.map(r => r.total_div_post);
            const dataGrowthCum = history.map(r => r.capital_growth_post);
            const dataMonthlyDiv = history.map(r => r.monthly_div_post);

            // Optional: Real Value Line
            const dataRealAsset = history.map(r => r.asset_post_real);

            const datasets = [
                {
                    label: 'ì›”ë°°ë‹¹ê¸ˆ (ìš°ì¸¡)',
                    data: dataMonthlyDiv,
                    borderColor: '#fb923c', // Orange-400
                    borderWidth: 2,
                    yAxisID: 'y1',
                    pointRadius: 0,
                    borderDash: [5, 5],
                    type: 'line',
                    order: 1
                },
                {
                    label: 'ì£¼ê°€ ìˆ˜ìµ',
                    data: dataGrowthCum.map((v, i) => v + dataDivCum[i] + dataPrincipal[i]), // Stacked Manually for Fill?
                    // Chart.js stacked area works better with raw values if stacked: true
                    // But here we want areas. Let's use 'fill: "-1"' approach or strict stacking.
                    // Stacking Setup: Principal (Bottom) -> Div (Middle) -> Growth (Top)
                    backgroundColor: 'rgba(239, 68, 68, 0.3)', // Red
                    borderColor: 'transparent',
                    fill: '-1', // Fill to previous dataset
                    pointRadius: 0,
                    order: 3
                },
                {
                    label: 'ì¬íˆ¬ì ëˆ„ì ',
                    data: dataDivCum.map((v, i) => v + dataPrincipal[i]),
                    backgroundColor: 'rgba(34, 197, 94, 0.3)', // Green
                    borderColor: 'transparent',
                    fill: '-1',
                    pointRadius: 0,
                    order: 4
                },
                {
                    label: 'ì›ê¸ˆ',
                    data: dataPrincipal,
                    backgroundColor: 'rgba(59, 130, 246, 0.3)', // Blue
                    borderColor: '#3b82f6',
                    fill: 'origin',
                    pointRadius: 0,
                    order: 5
                }
            ];

            if (params.inflation_rate > 0) {
                datasets.push({
                    label: 'ì‹¤ì§ˆ ê°€ì¹˜ (ë¬¼ê°€ë°˜ì˜)',
                    data: dataRealAsset,
                    borderColor: '#ffffff',
                    borderWidth: 2,
                    pointRadius: 0,
                    type: 'line',
                    order: 2, // Layer on top of area
                    borderDash: [2, 2]
                });
            }

            simChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: { display: false },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            grid: { color: '#333' },
                            ticks: { callback: (v) => v / 10000 + 'ë§Œ' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: { display: false },
                            ticks: { callback: (v) => v / 10000 + 'ë§Œ', color: '#fb923c' }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) label += formatVal(context.parsed.y) + 'ì›';
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // -----------------------
        // Analysis Logic (Sector Pie Chart)
        // -----------------------
        let sectorChart = null;

        function openAnalysis() {
            document.getElementById('modal-analysis').classList.remove('hidden');
            renderSectorStart();
        }

        function closeAnalysis() {
            document.getElementById('modal-analysis').classList.add('hidden');
        }

        function renderSectorStart() {
            const ctx = document.getElementById('chart-sector').getContext('2d');
            if (sectorChart) sectorChart.destroy();

            // 1. Aggregate Value by Sector
            const sectorMap = {}; // { 'Tech': 1000000, ... }
            let totalVal = 0;

            Object.keys(portfolio).forEach(symbol => {
                const qty = portfolio[symbol].qty;
                if (qty <= 0) return;

                const item = universe.find(x => x.symbol === symbol);
                if (!item) return; // Should not happen

                const val = (item.data.price || 0) * qty;
                // Use 'sector' field if available, else 'ê¸°íƒ€(Unknown)'
                let sector = item.data.sector || 'ê¸°íƒ€';
                if (!sector.trim()) sector = 'ê¸°íƒ€';

                if (!sectorMap[sector]) sectorMap[sector] = 0;
                sectorMap[sector] += val;
                totalVal += val;
            });

            if (totalVal === 0) {
                // Show empty chart or message
                return;
            }

            // 2. Prepare Data for Chart
            const labels = Object.keys(sectorMap);
            const data = Object.values(sectorMap);

            // Generate Colors
            const predefinedColors = [
                '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
                '#ec4899', '#6366f1', '#14b8a6', '#f97316', '#a855f7'
            ];
            const bgColors = labels.map((_, i) => predefinedColors[i % predefinedColors.length]);

            sectorChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: bgColors,
                        borderWidth: 1,
                        borderColor: '#111'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#ccc', font: { size: 11 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const v = context.parsed;
                                    const pct = ((v / totalVal) * 100).toFixed(1);
                                    return ` ${context.label}: ${formatVal(v)} (${pct}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function exportSimulationCSV() {
            if (!lastSimData) return;

            let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // BOM
            csvContent += "ê¸°ê°„,ì´ìì‚°(ì„¸í›„),ì›”ë°°ë‹¹(ì„¸í›„),ì¬íˆ¬ìì•¡,í˜„ê¸ˆìˆ˜ì·¨,ëˆ„ì ì›ê¸ˆ,ëˆ„ì ìì‚°ìˆ˜ìµ,ëˆ„ì ë°°ë‹¹ìˆ˜ìµ\n";

            lastSimData.forEach(row => {
                csvContent += `${row.period},${row.asset_post},${row.monthly_div_post},${row.reinvest_post},${row.cash_div_post},${row.principal_post},${row.capital_growth_post},${row.total_div_post}\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "dividend_simulation.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Export/Import Logic
        function exportPortfolio(name, fmt = 'json') {
            const url = `/api/portfolio/export?name=${encodeURIComponent(name)}&format=${fmt}`;
            window.location.href = url;
        }

        async function importPortfolioFile(input) {
            if (!input.files || input.files.length === 0) return;
            const file = input.files[0];

            const formData = new FormData();
            formData.append('file', file);

            try {
                // Show loading state?
                const btn = input.nextElementSibling;
                const originalText = btn.innerHTML;
                btn.innerText = 'Uploading...';
                btn.disabled = true;

                const res = await fetch('/api/portfolio/import', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();

                btn.innerHTML = originalText;
                btn.disabled = false;

                if (res.ok) {
                    alert(`ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤: ${data.name} (${data.count} items)`);
                    loadPortfolioList(); // Refresh list to show new item
                } else {
                    alert('Import failed: ' + (data.error || 'Unknown Error'));
                }
            } catch (e) {
                alert('Upload Error');
                // Reset button if error
                const btn = input.nextElementSibling;
                if (btn) btn.disabled = false;
            }
            input.value = ''; // Reset
        }

        // -----------------------
        // Calendar Logic
        // -----------------------
        let calendarChart = null;

        function openCalendar() {
            document.getElementById('modal-calendar').classList.remove('hidden');
            renderCalendar();
        }

        function closeCalendar() {
            document.getElementById('modal-calendar').classList.add('hidden');
        }

        function renderCalendar() {
            const ctx = document.getElementById('chart-calendar').getContext('2d');
            if (calendarChart) calendarChart.destroy();

            // Initialize 12 months (Jan=0, Dec=11)
            const monthlySum = new Array(12).fill(0);

            // Logic: Scan Portfolio
            Object.keys(portfolio).forEach(symbol => {
                const qty = portfolio[symbol].qty;
                if (qty <= 0) return;
                const item = universe.find(x => x.symbol === symbol);
                if (!item) return;

                const dData = item.data;
                const history = dData.dist_history || [];

                // Strategy 1: Use History (Last 12 Months)
                let useHistory = false;
                if (history && history.length > 0) {
                    const lastDate = new Date(history[0].date);
                    const oneYearAgo = new Date();
                    oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);

                    if (lastDate > oneYearAgo) {
                        useHistory = true;
                        // Sum up amounts per month for the last 12 months valid data
                        // Only count payments that happened within the last 365 days?
                        // OR simply count distinct months present in the last year's history
                        history.forEach(h => {
                            const d = new Date(h.date);
                            if (d > oneYearAgo) {
                                monthlySum[d.getMonth()] += h.amount * qty;
                            }
                        });
                    }
                }

                // Strategy 2: Estimate based on Base Date & Frequency
                if (!useHistory && dData.dist_base_date && dData.dist_freq_1y > 0) {
                    // Try parsing date
                    let year, month, day;
                    // Format: YYYY-MM-DD or YYYY.MM.DD
                    const parts = dData.dist_base_date.replace(/\./g, '-').split('-');
                    if (parts.length === 3) {
                        year = parseInt(parts[0]);
                        month = parseInt(parts[1]) - 1; // 0-indexed
                        day = parseInt(parts[2]);

                        const freq = dData.dist_freq_1y;
                        let amt = dData.dist_amount_recent || 0;
                        if (amt === 0 && dData.est_annual_amount > 0) {
                            amt = dData.est_annual_amount / freq;
                        }

                        if (amt > 0 && !isNaN(month)) {
                            if (freq >= 12) {
                                // Monthly
                                for (let m = 0; m < 12; m++) monthlySum[m] += amt * qty;
                            } else if (freq === 4) {
                                // Quarterly
                                for (let i = 0; i < 4; i++) {
                                    monthlySum[(month + i * 3) % 12] += amt * qty;
                                }
                            } else if (freq === 1) {
                                // Annual
                                monthlySum[month] += amt * qty;
                            } else {
                                // Other
                                monthlySum[month] += amt * qty;
                                if (freq === 2) monthlySum[(month + 6) % 12] += amt * qty;
                            }
                        }
                    }
                }
            });

            // Prepare Data
            const labels = ["1ì›”", "2ì›”", "3ì›”", "4ì›”", "5ì›”", "6ì›”", "7ì›”", "8ì›”", "9ì›”", "10ì›”", "11ì›”", "12ì›”"];

            calendarChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì˜ˆìƒ ì›” ë°°ë‹¹ê¸ˆ',
                        data: monthlySum,
                        backgroundColor: (ctx) => {
                            const v = ctx.raw;
                            return v > 0 ? 'rgba(168, 85, 247, 0.6)' : 'rgba(55, 65, 81, 0.3)'; // Purple-500
                        },
                        borderColor: 'rgba(168, 85, 247, 1)',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#333' },
                            ticks: { callback: (v) => formatVal(v), color: '#999', font: { size: 10 } }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#ccc', font: { size: 11 } }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return ` ì˜ˆìƒ ë°°ë‹¹: ${formatVal(context.parsed.y)}ì›`;
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: `ì—°ê°„ ì˜ˆìƒ ë°°ë‹¹ê¸ˆ í•©ê³„: ${formatVal(monthlySum.reduce((a, b) => a + b, 0))}ì›`,
                            color: '#e5e7eb',
                            font: { size: 14 }
                        }
                    }
                }
            });
        }

        document.getElementById('search-input').addEventListener('input', renderUniverse);

        // document.getElementById('sort-select').addEventListener('change', renderUniverse); // Removed
    </script>
</body>

</html>